# About Snowflake - 关于 Snowflake

## 概述

Snowflake 是 Twitter 开源的分布式 ID 生成算法，用于在分布式系统中生成全局唯一、趋势递增的 ID。
其核心思想是将一个 64 位整数划分为多个部分，分别表示时间戳、工作节点 ID 和序列号，确保高并发环境下 ID 的唯一性和有序性。

## 核心特性

1. 全局唯一：分布式环境下生成的 ID 无冲突。
2. 趋势递增：基于时间戳排序，利于数据库索引。
3. 高性能：本地生成无网络开销，每秒可生成百万级 ID。
4. 轻量依赖：无需数据库 / Redis 等第三方服务。

## ID 结构（64位）

| 组成部分    | 位数     | 说明                           |
|---------|--------|------------------------------|
| 符号位     | 1 bit  | 恒为 0（正数）                     |
| 时间戳     | 41 bit | 毫秒级时间差（自定义起始时间）              |
| 数据中心 ID | 5 bit  | 数据中心 ID（支持最多 `32` 个数据中心）     |
| 机器 ID   | 5 bit  | 每个数据中心内的机器 ID（支持最多 `32` 台机器） |
| 序列号     | 12 bit | 每毫秒自增序列（支持每节点每毫秒 `4096` ID）  |

ID 示例：

```text
1299054972024274944
```

二进制解析：

```text
0 | 001 0010 0000 0111 0010 1011 1001 1101 0100 0111 00 | 11 011 | 0 0100 | 0000 0000 0000
+ |                      timestamp                      |  dcid  |  maid  |    sequence   
```

## 适用场景

- 分布式系统中需要生成全局唯一 ID 的场景。
- 需要高并发 ID 生成的应用，如电商订单号、用户 ID 等。
- 需要有序 ID 的场景，如日志系统、消息队列等。
- 需要轻量级 ID 生成的应用，无需依赖数据库或 Redis。
- 需要高性能 ID 生成的场景，如大数据处理、实时分析等。

## 在本项目中的应用

1. 分布式部署时，需要确保每个节点的 `data_center_id@machine_id` 唯一，可以在相应的配置文件中设置。
2. 本项目的时间回拨处理逻辑是基于阻塞等待的方式实现的，请确保部署本项目的机器不会出现长时间的时间回拨。
3. 本项目的 `TWEPOCH` 为可配置项（键名 `snowflake.twepoch`）。
   未配置时将使用默认值 `SnowflakeConstants.DEFAULT_TWEPOCH`（默认日期为 2015-01-01，毫秒值 `1420041600000`）。
   41 位毫秒时间戳可覆盖约 69 年的时间跨度，因此“用尽时间”取决于实际的 `TWEPOCH` 配置；
   若采用默认值，则约在 `2084` 年左右达到上限。

## 时间位宽与可用窗口

- 41 位毫秒时间戳可表示的区间为 `\(2^{41}\)` 毫秒，约为 `2,199,023,255,552 ms`，折合约 `69.73` 年。
- 可用窗口的结束时间 = `TWEPOCH` 对应起始日期 + 约 `69.73` 年。
- 示例：
   - 若 `TWEPOCH` 使用默认值（2015-01-01），可用窗口将于约 `2084` 年左右达到上限。
   - 若调整 `TWEPOCH`，可用窗口的结束时间将随之整体平移。
- 强约束（务必遵守）：
   - 全网所有节点的 `TWEPOCH` 必须完全一致。
   - 仅允许在系统正式投产前设定，一旦上线后严禁修改。
   - 擅自变更将导致 ID 无序、重复、索引退化与数据一致性风险。
